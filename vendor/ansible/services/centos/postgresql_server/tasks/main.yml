- name: Install the CentOS 7 postgres yum repo
  become: true
  yum:
    name: https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ansible_distribution_major_version}}-x86_64/pgdg-redhat-repo-latest.noarch.rpm
    state: present
  when:
    - ansible_distribution == "CentOS"

- name: Install PostgreSQL 9.6 packages
  become: true
  package: name={{ item }} state=present
  with_items:
    - python-psycopg2
    - postgresql96-server
    - postgresql96-contrib
  when: postgres_version|string == "9.6"

- name: Install PostgreSQL 11.0 packages
  become: true
  package: name={{ item }} state=present
  with_items:
    - python-psycopg2
    - postgresql11
    - postgresql11-server
    - postgresql11-contrib
  when: postgres_version|string == "11"

- name: Install PostgreSQL 12.0 packages
  become: true
  package: name={{ item }} state=present
  with_items:
    - python-psycopg2
    - postgresql12
    - postgresql12-server
    - postgresql12-contrib
  when: postgres_version|string == "12"

- name: Check if postgresql data directory exists
  become: true
  find:
    paths: /var/lib/pgsql/{{postgres_version}}/data/
    file_type: directory
    patterns: "*"
  register: dir_files

- name: Init database
  become: true
  shell: /usr/pgsql-9.6/bin/postgresql96-setup initdb
  when: dir_files.matched|int == 0 and postgres_version|string == "9.6"

- name: Init database
  become: true
  shell: /usr/pgsql-11/bin/postgresql-11-setup initdb
  when: dir_files.matched|int == 0 and postgres_version|string == "11"

- name: Init database
  become: true
  shell: /usr/pgsql-12/bin/postgresql-12-setup initdb
  when: dir_files.matched|int == 0 and postgres_version|string == "12"

- name: Copy postgresql configuration
  become: true
  template:
    src: postgresql_{{postgres_version}}.conf.j2
    dest: /var/lib/pgsql/{{postgres_version}}/data/postgresql.conf
    owner: "{{pg_user}}"
    group: "{{pg_group}}"
    mode: 0600
  when: postgres_version == 11 or postgres_version == 12
  notify: Restart Postgres

# This is the default config, but it's aimed to ve overwritten by specific roles
- name: Configure default postgresql access
  become: true
  copy:
    src: pg_hba.conf
    dest: /var/lib/pgsql/{{postgres_version}}/data/pg_hba.conf
  notify: Restart Postgres

- name: Add binaries to PATH
  become: true
  template:
    src: pg.sh.j2
    dest: /etc/profile.d/pg.sh
    owner: root
    group: root
    mode: 0755

- name: Ensure postgresql service is running
  become: true
  service: name=postgresql-{{postgres_version}} state=started enabled=yes

- name: Copy monit config file
  become: true
  template:
    src: postgresql.monit.j2
    dest: /etc/monit.d/postgresql.monit
  notify: Restart Monit

- name: Create folder to archive backups
  become: true
  file: state=directory path={{backups_folder}} owner={{backups_user}} group={{backups_user}} mode=0774

- name: Enable cron
  become: true
  template: src=cron.j2 dest=/etc/cron.d/db_backups

- name: Create backups script in backups folder
  become: true
  template: src=db_backups.j2 dest={{backups_folder}}/db_backups.sh owner={{backups_user}} group={{backups_user}} mode=0774
